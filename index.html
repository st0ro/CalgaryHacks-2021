<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans">
    <title>Zoomer</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
    <style>
        body,
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Noto Sans', sans-serif;
            color: white;
        }
    </style>
</head>

<body style="background-color: #36393F;" onload="clock();loadSchedule()">
    <div class="w3-sidebar w3-bar-block" style="width:80px; background-color: #202225;">
        <img src="icons/home.png" class="w3-bar-item w3-button w3-hover-gray" onclick="selectView('view-home')">
        <img src="icons/calender.png" class="w3-bar-item w3-button w3-hover-gray" onclick="selectView('view-schedule')">
        <img src="icons/gear.png" class="w3-bar-item w3-button w3-hover-gray" style="position: absolute; bottom: 0px;" onclick="">
    </div>
    <div style="margin-left: 80px;">
        <!-- HARD CODE THE HEIGHT AND  WIDHT TO PIXELS-->
        <div class="w3-container w3-display-container-gray view-selector" id="view-home"
            style="margin-left: 10%; height: 100%; width: 90%">
            <!-- home page-->
            <div class="w3-display-middle" style="text-align: center">
                <div>
                    <h1 id="time-display" style="font-size: 60px">16:40</h1>
                    <h3 id="next-meeting">Upcoming: <b>SENG 471</b> in <b>15 minutes</b></h3>
                    <button id="launch-zoom" class="w3-button w3-red" data-link="http://www.google.com"
                        style="visibility: hidden;">Join Zoom</button>
                </div>
            </div>
        </div>
        <div class="w3-container view-selector" id="view-schedule" style="visibility: hidden;">
            <!--schedule page-->
            <div style="font-size: 30px; padding-top: 8px; padding-bottom: 8px;">Schedule</div>
            <img src="icons/add.png" class="w3-button w3-hover-gray"
                style="position: fixed; top:14px; height:36px; right:8px;"
                onclick="document.getElementById('addToSchedule').style.display='block'">

            <div id="addToSchedule" class="w3-modal">
                <div class="w3-modal-content w3-card-4 w3-light-grey w3-display-middle" style="max-width:600px">

                    <div class="w3-center"><br>
                        <span onclick="document.getElementById('addToSchedule').style.display='none'"
                            class="w3-button w3-xlarge w3-hover-red w3-display-topright"
                            title="Close Modal">&times;</span>
                        <label><b>Add a class</b></label>
                    </div>

                    <form class="w3-container">
                        <div class="w3-section">
                            <label><b>Session Name</b></label>
                            <input class="w3-input w3-border w3-margin-bottom" type="text"
                                placeholder="Eg: MATH 101 Lecture" id="sessionName" required>
                            <label><b>Zoom Session ID</b></label>
                            <input class="w3-input w3-border w3-margin-bottom" type="text" placeholder="Eg: 1234567890"
                                id="sessionId" required>
                            <label><b>Password</b></label>
                            <input class="w3-input w3-border w3-margin-bottom" type="text" placeholder="Eg: LetMeIn"
                                id="pwd">
                            <label><b>Day of Week<br></b></label>
                            <div id="dow" class="w3-container w3-center">
                                <input name="monday" class="w3-check day-selector" type="checkbox"> Monday
                                <input name="tuesday" class="w3-check w3-margin-left day-selector" type="checkbox">
                                Tuesday
                                <input name="wednesday" class="w3-check w3-margin-left day-selector" type="checkbox">
                                Wednesday
                                <input name="thursday" class="w3-check w3-margin-left day-selector" type="checkbox">
                                Thursday
                                <input name="friday" class="w3-check w3-margin-left day-selector" type="checkbox"> Friday
                            </div>
                            <div class="w3-container w3-margin-top">
                                <div class="w3-container w3-left">
                                    <label><b>Start time<br></b></label>
                                    <input type="time" id="startTime" name="start" required>
                                </div>
                                <div class="w3-container w3-right">
                                    <label><b>End time</b><br></label>
                                    <input type="time" id="endTime" name="end" required>
                                </div>
                            </div>
                        </div>
                    </form>

                    <div class="w3-container w3-border-top w3-padding-16 w3-light-grey">
                        <button onclick="document.getElementById('addToSchedule').style.display='none'" type="button"
                            class="w3-button w3-left w3-red">Cancel</button>
                        <button onclick="addCourse()" class="w3-button w3-right w3-green" type="submit">Add</button>
                    </div>

                </div>
            </div>

            <div id="viewSession" class="w3-modal">
                <div class="w3-modal-content w3-card-4 w3-light-grey w3-display-middle" style="max-width:600px">

                    <div class="w3-center"><br>
                        <span onclick="document.getElementById('viewSession').style.display='none'"
                            class="w3-button w3-xlarge w3-hover-red w3-display-topright"
                            title="Close Modal">&times;</span>
                        <label><b>Session Details</b></label>
                    </div>
                    <div style="text-align: center;">
                        <div id="sessionName"></div>
                        <div id="meetingID"></div>
                        <div id="meetingPassword"></div>
                        <div id="startTime"></div>
                        <div id="endTime"></div>
                        <div class="w3-container w3-border-top w3-padding-16 w3-light-grey">
                            <button onclick="document.getElementById('viewSession').style.display='none'" type="button"
                                class="w3-button w3-middle w3-red">Cancel</button>
                        </div>

                    </div>
                </div>
            </div>
            <div class="w3-cell-row;">
                <div class="w3-cell" style="position: relative;height:475px;text-align: center; width: 80px">
                    <div style="position: fixed; top: 87px;right:845px">8:00</div>
                    <div style="position: fixed; top: 172px;right:845px">10:00</div>
                    <div style="position: fixed; top: 257px;right:845px">12:00</div>
                    <div style="position: fixed; top: 342px;right:845px">14:00</div>
                    <div style="position: fixed; top: 427px;right:845px">16:00</div>
                    <div style="position: fixed; top: 511px;right:845px">18:00</div>
                </div>
                <div class="w3-cell" id="monday"
                    style="background-color:#32353B; height:475px;text-align: center; width: 200px">
                    Monday
                </div>
                <div class="w3-cell" id="tuesday" style="height:475px;text-align: center; width: 200px">
                    Tuesday
                </div>
                <div class="w3-cell" id="wednesday"
                    style="background-color:#32353B; height:475px;text-align: center; width: 200px">
                    Wednesday
                </div>
                <div class="w3-cell" id="thursday" style="height:475px;text-align: center; width: 200px">
                    Thursday
                </div>
                <div class="w3-cell" id="friday"
                    style="background-color:#32353B; height:475px;text-align: center; width: 200px">
                    Friday

                </div>
            </div>
        </div>
        <div class="view-selector" id="view-3" style="visibility: hidden;">
            <!--some page-->
        </div>
    </div>
</body>

<script>
    function loadSchedule() {
        var e;
        var sessions = loadSessions();
        for (let i = 0; i < sessions.length; i++) {
            var s = sessions[i];
            var width;
            e = document.getElementById(s.dayOfWeek);
            var pixels = getSingularBlockLocation(s.startHour, s.startMin, s.endHour, s.endMin);
            switch (s.dayOfWeek) {
                case "monday":
                    width = 161;
                    break;
                case "tuesday":
                    width = 161;
                    break;
                case "wednesday":
                    width = 180;
                    break;
                case "thursday":
                    width = 161;
                    break;
                case "friday":
                    width = 155;
                    break;
            }
            e.innerHTML += '<div class = "w3-red w3-hover-pale-red"  style = "position:fixed;top: ' + pixels[0] + 'px; height:'
                + (pixels[1] - pixels[0]) + 'px;width:' + width + 'px; background-color:' + s.colour + `" onclick="viewSessionModal('${s.dayOfWeek}', ${s.startHour}, ${s.startMin})"> ` + s.sessionName + '</div>';
            console.log(s.sessionName + "  " + pixels[0] + "added");

        }
    }

    function getSingularBlockLocation(startHour, startMin, endHour, endMin) {
        var pixels = [];
        pixels[0] = pixelLocation(startHour, startMin);
        pixels[1] = pixelLocation(endHour, endMin);

        return pixels;
    }

    function pixelLocation(hour, min) {
        return ((((Number(hour) - 8) * 60 + Number(min)) / 600) * 424) + 95;
    }

    function selectView(selected) {
        var e = document.getElementsByClassName("view-selector");
        for (let i = 0; i < e.length; i++) {
            e[i].style.visibility = "hidden";
        }
        document.getElementById(selected).style.visibility = "visible";
    }

    function clock() {
        var today = new Date();
        var h = today.getHours();
        var m = today.getMinutes();
        if (m < 10) { m = "0" + m }
        document.getElementById('time-display').innerHTML = h + ":" + m;
        loadHomepage();
        var t = setTimeout(clock, 10000);
    }

    function addCourse() {
        var sTime = document.getElementById("startTime").value;
        var eTime = document.getElementById("endTime").value;
        sTime = sTime.split(":");
        eTime = eTime.split(":");
        var selectors = document.getElementsByClassName("day-selector");
        for (var i = 0; i < selectors.length; i++) {
            if (selectors[i].checked) {
                var s = new Session(document.getElementById("sessionName").value, document.getElementById("sessionId").value, document.getElementById("pwd").value,
                    selectors[i].name, "", sTime[0], sTime[1], eTime[0], eTime[1], "blue");
                addSession(s);
            }
        }
        document.getElementById('addToSchedule').style.display = 'none';
        loadSchedule();
    }

    const { shell } = require('electron')

    function openLink(link) {
        shell.openExternal(link);
        //openLink('zoommtg:\/\/ucalgary.zoom.us\/join?action=join&confno=2578813624');
    }

    function loadHomepage() {
        let sessions = loadSessions();
        var d = new Date();
        var dayOfWeek = d.getDay();
        var currentMins = toMins(d.getHours(), d.getMinutes);
        var sessionsToday = [];
        var currentSession;
        for (let i = 0; i < sessions.length; i++) {
            let endMins = toMins(sessions[i].endHour, sessions[i].endMin);
            if (sessions[i].dayOfWeek === dayOfWeek && endMins >= currentMins) {
                let startMins = toMins(sessions[i].startHour, sessions[i].startMin);
                sessions[i].startMins = startMins;
                sessions[i].endMins = endMins;
                if (startMins <= currentMins && currentMins >= endMins) {
                    currentSession = sessions[i];
                }
                sessionsToday.push(sessions[i]);
            }
        }
        if (sessionsToday.length > 0) {
            if (typeof currentSession !== 'undefined') {
                document.getElementById('next-meeting').innerHTML = `Current session: <b>${currentSession.sessionName}</b> (${currentSession.startHour}:${currentSession.startMin} to ${currentSession.endHour}:${currentSession.endMin})`;
                document.getElementById('launch-zoom').visibility = "visible";
            }
            else {
                sessionsToday.sort((a, b) => {
                    return a.startMins - b.startMins;
                });
                let text = `Upcoming: <b>${sessionsToday[0]}</b> in `;
                let timeLeft = sessionsToday[0].startMins - currentMins;
                if (timeLeft > 60) {
                    text += `<b>${timeLeft / 60} hour(s)</b> and `;
                }
                text += `<b>${timeLeft % 60} minute(s)</b>`;
                document.getElementById('next-meeting').innerHTML = text;
                document.getElementById('launch-zoom').visibility = "visible";
            }
        }
        else {
            document.getElementById('next-meeting').innerHTML = "No more sessions scheduled for today";
            document.getElementById('launch-zoom').visibility = "hidden";
        }
    }

    function toMins(hour, min) {
        return hour * 60 + min;
    }

    function viewSessionModal(dayOfWeek, startHour, startMin) {
        var sessions = loadSessions();
        var target
        for (let i = 0; i < sessions.length; i++) {
            if (dayOfWeek === sessions[i].dayOfWeek && startHour === sessions[i].startHour && startMin === sessions[i].startMin) {
                target = sessions[i]
            }
        }
        console.log(`tried to view modal for ${target.dayOfWeek}, ${target.startHour}:${target.startMin}`)
        document.getElementById('sessionName').innerHTML = target.sessionName
        document.getElementById('meetingID').innerHTML = target.meetingId
        document.getElementById('meetingPassword').innerHTML = target.password
        document.getElementById('startTime').innerHTML = target.startHour + ":" + target.startMin
        document.getElementById('endTime').innerHTML = target.endHour + ":" + target.endMin
        document.getElementById('viewSession').style.display = 'block'
    }
</script>
<script src="schedules.js"></script>

</html>